<!DOCTYPE html>
<html>
<head>
    <title>Quick Start - Leaflet</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #mapid {
            height: 100%;
            width: 100%;
            background: #fff
        }
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="script.js"></script>
</head>
<body>

<div id="mapid">
<!--    <div class="leaflet-overlay-pane">-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 201px;" src="images/TomGaustad/TG_2_1200_878.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 201px;" src="images/TimHereid/TH_1_1200_803.jpg" alt=""></div>-->
<!--    </div>-->
</div>
<script>

    var imagesList = [];
    $.ajaxSetup({ // avoid array being populated asynchronously
        async: false
    });

    var mymap = L.map('mapid', {
        attributionControl: false,
        zoomControl: false
    }).setView([0.0, 0.0], 8);

    var uniqueImagesPanel = [];
    var uniqueImagesPanelArtistsIds = [];
    // var restAllImages = [];

    // TODO: for testing
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 0, null, 0));
    // imagesList.push(addImage("images/AndreasTystad/AY_3_800_1200.jpg", -2, imagesList[0], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 1, imagesList[0], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 2, imagesList[0], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 2, imagesList[0], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -2, imagesList[0], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -1, imagesList[0], 0));
    // imagesList.push(addImage("images/AndreasTystad/AY_3_800_1200.jpg", -1, imagesList[0], 2.2));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 2, imagesList[7], 0));
    // imagesList.push(addImage("images/PalBringe/PB_2_1195_1200.jpg", 1, imagesList[8], 0)); //
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -2, imagesList[6], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 1, imagesList[3], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", 1, imagesList[1], -2.2));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -2, imagesList[11], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -2, imagesList[5], 0));
    // imagesList.push(addImage("images/OscarWarpe/OW_3_1200_800.jpeg", -1, imagesList[10], 2.2));
    // imagesList.push(addImage("images/AndreasTystad/AY_3_800_1200.jpg", 1, imagesList[11], 0));
    // TODO: end for testing.

    // ?????????????????
    let layout;
    $.getJSON("images/layout.json", function(json) {
        layout = json;
    });

    let artistIndex;
    $.getJSON( "images/artist-index.json", function( data ) {
        artistIndex = data;
        // $.each(data, function (artistName, imageArray) {
        //     uniqueImagesPanel.push("images/"+artistName+"/"+imageArray[0]); // add first image for unique images panel first
        //
        //     // $.each(imageArray, function (index, imagePath) {
        //     //     if (index !== 0) { // add the rest of the images to be added in a
        //     //         restAllImages.push("images/"+artistName+"/"+imagePath);
        //     //     }
        //     // });
        // });
    });
    let artistNames = Object.keys(artistIndex);
    artistIndex = Object.values(artistIndex);

    // console.log(imagesSettings[0]);

    let counterInitialPanel = 0;
    let limitInitialPanelSize = layout.presentationPanel.length;
    while (counterInitialPanel < limitInitialPanelSize) {
        let setting = layout.presentationPanel[counterInitialPanel];
        let randomizedArtistIndexes = shuffle(artistIndex);

        let image = getRandomUniqueImageFromArtist(randomizedArtistIndexes, setting.direction);
        let artistName = getArtistNameFromImageName(image);
        let imageFullPath = `images/${artistName}/${image}`;

        injectImage(imageFullPath, setting);

        counterInitialPanel++;
    }
    // /???????????????????????

    function getArtistNameFromImageName(imageName) {
        let initials = imageName.split('_')[0];
        console.log(initials);
        if (initials === "AM") {
            return "AdaMiko";
        }
        if (initials === "AT") {
            return "AmalieTrones";
        }
        if (initials === "AY") {
            return "AndreasTystad";
        }
        if (initials === "AE") {
            return "AnnaMelbye";
        }
        if (initials === "CL") {
            return "CamillaLouadah";
        }
        if (initials === "DR") {
            return "DanielRognskog";
        }
        if (initials === "EM") {
            return "EmilyMcLean";
        }
        if (initials === "FB") {
            return "FredrikBedsvaag";
        }
        if (initials === "OW") {
            return "OscarWarpe";
        }
        if (initials === "PB") {
            return "PalBringe";
        }
        if (initials === "SS") {
            return "SofieSvanes";
        }
        if (initials === "SL") {
            return "StefanLakselvhaug";
        }
        if (initials === "TS") {
            return "TanjaSilvestrini";
        }
        if (initials === "TH") {
            return "TimHereid";
        }
        if (initials === "TG") {
            return "TomGaustad";
        }
        if (initials === "TR") {
            return "TuvaRasmussen";
        }
        if (initials === "VL") {
            return "VeraLunde";
        }
    }

    function injectImage(imagePath, setting) {
        console.log(imagePath);
        let imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
        let imageWidth = imageName.split('_')[2];
        let imageHeight = imageName.split('_')[3].split('.')[0];

        let originPoint = mymap.latLngToContainerPoint([setting.originX, setting.originY]);
        let nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
        let nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);

        let imageBounds = [[setting.originX, setting.originY], nextCornerLatLng];
        L.imageOverlay(imagePath, imageBounds, {opacity: 1})
            .addTo(mymap);
    }

    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
    }

    function getRandomUniqueImageFromArtist(artistIndex, direction) {
        let selectedImage = null;

        $.each(artistIndex, (artistId, images) => {
            let artistImages = shuffle(images); // randomize list of images.
            let artistIdFound = false;
            $.each(artistImages, (imageIndex, imageName) => {
                let artistInitials = imageName.split('_')[0];
                if (matchesImageDirection(imageName, direction)
                    && !uniqueImagesPanel.includes(imageName)
                    && !uniqueImagesPanelArtistsIds.includes(artistInitials)) {
                    selectedImage = imageName;
                    artistIdFound = true;
                    uniqueImagesPanel.push(imageName);
                    uniqueImagesPanelArtistsIds.push(artistInitials);
                    return false;
                }
            });
            if (artistIdFound) {
                return false;
            }
        });

        return selectedImage;
    }

    function matchesImageDirection(imageName, direction) {
        let imageWidth = parseInt(imageName.split('_')[2]);
        let imageHeight = parseInt(imageName.split('_')[3].split('.')[0]);
        if (Math.abs(imageWidth - imageHeight) < 100) { // Threshold for considering and image square.
            return direction.localeCompare("central") === 0;
        } else if (imageWidth > imageHeight) { // horizontal
            return direction.localeCompare("horizontal") === 0;
        } else {
            return direction.localeCompare("vertical") === 0;
        }
    }

    // add first image.
    // let imageName = uniqueImagesPanel[0].split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
    // let imageWidth = imageName.split('_')[2];
    // let imageHeight = imageName.split('_')[3].split('.')[0];
    // imagesList.push(addImage(uniqueImagesPanel[0], 0, null, imageWidth, imageHeight));
    // let previousImageWidth = imageWidth;

    // populatePanel(uniqueImagesPanel, restAllImages, linesPattern);

    // let imageBounds = [[0, 0], L.latLng(4.36832, 6.591797)];
    // L.imageOverlay("images/AdaMiko/AM_3_1200_796.JPG", imageBounds, {opacity: 1})
    //     .addTo(mymap)
    //     .on('click', function() {
    //         alert('222');
    //     });

    // let imageBounds = [[variableOriginX, variableOriginY], nextCornerLatLng];
    //
    // let newImage = L.imageOverlay(imagePath, imageBounds, {opacity: 1})
    //     .addTo(mymap)
    //     .on('click', function() {
    //         alert('222');
    //     });
    // imagesList.push(newImage);

    function extractImageAndProcess(imagePath, direction, parentIndex, imageWidth, imageHeight, lineLimit, toggleDirection, index, restAllImages, linesPattern) {
        imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight));
        parentIndex++;

        // calculate if limit of pictures for current line is reached
        // if (imageWidth <= previousImageWidth) {
        //     lineLimit--;
        // }
        // previousImageWidth = imageHeight;

        // if images is already moved up, toggle back to horizontal moving.
        // if (Math.abs(direction) === 1) {
        //     direction = 2 * toggleDirection;
        // }

        // insert one image upwards and change direction
        // console.log(lineLimit);
        if (lineLimit === 0) {
            if (index < restAllImages.length / 3) {
                direction = 1;
            } else {
                direction = -1;
            }
            toggleDirection *= -1;
            lineLimit = linesPattern.pop();
        }
        return {direction, parentIndex, lineLimit, toggleDirection};
    }

    function populatePanel(uniqueImagesPanel, restAllImages, linesPattern) {
        let direction = 2; // starting direction right
        let toggleDirection = 1; // switch between adding to the right and adding to the left
        let lineLimit = linesPattern.pop();
        let parentIndex = 0; //TODO: remove?

        // $.each(uniqueImagesPanel, function(index, imagePath) {
        let randomItemArray = [];
        let interation = 0;
        while (randomItemArray.length < uniqueImagesPanel.length) {
            let number1 = Math.round(Math.random() * (uniqueImagesPanel.length - 2)) + 1;
            let imagePath = uniqueImagesPanel[number1];

            while (randomItemArray.includes(imagePath) && interation <= restAllImages.length) {
                let number2 = Math.round(Math.random() * (uniqueImagesPanel.length - 2)) + 1;
                imagePath = uniqueImagesPanel[number2];
                interation++;
            }
            randomItemArray.push(imagePath);

            let imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
            let imageWidth = imageName.split('_')[2];
            let imageHeight = imageName.split('_')[3].split('.')[0];

            // if (index !== 0) { // first image is added separately above.
            imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight, toggleDirection));
            parentIndex++;
            toggleDirection *= -1;

        }
        // });

        randomItemArray = [];
        // $.each(restAllImages, function(index, imagePath) {
        while (randomItemArray.length < restAllImages.length) {
            let imagePath = restAllImages[Math.abs(Math.round(Math.random() * restAllImages.length) - 1)];
            interation = 0;
            while (randomItemArray.includes(imagePath) && interation <= restAllImages.length) {
                let number = Math.abs(Math.round(Math.random() * restAllImages.length) - 1);
                imagePath = restAllImages[number];
                interation++;
            }
            randomItemArray.push(imagePath);

            imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
            imageWidth = imageName.split('_')[2];
            imageHeight = imageName.split('_')[3].split('.')[0];

            imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight, toggleDirection));
            parentIndex++;
            toggleDirection *= -1;

        }

        // });

    }
    // 1 = UP
    // -1 = DOWN
    // 2 = RIGHT
    // -2 = LEFT

    mymap.setZoom(6);


    function addImage(imagePath, direction, parent, offset) {
        let imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
        let imageWidth = imageName.split('_')[2];
        let imageHeight = imageName.split('_')[3].split('.')[0];
        // console.log(imagePath + ":" + direction);
        if (direction === 0) { // this is the first image that has to be placed in the center
            let originPoint = mymap.latLngToContainerPoint([0,0]);
            let nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
            let nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
            let imageBounds = [[0, 0], nextCornerLatLng];
            console.log("nextCornerLatLng:" + nextCornerLatLng);
            console.log("variableOriginX:" + 0 + " variableOriginY:" + 0);
            if (Math.abs(imageWidth - imageHeight) < 100) { // Threshold for considering and image square.
                console.log("central");
            } else if (imageWidth > imageHeight) { // horizontal
                console.log("horizontal");
            } else {
                console.log("vertical");
            }
            return L.imageOverlay(imagePath, imageBounds).addTo(mymap);
        }

        let overlay = true;
        // if (toggleDirection === 1) {
        var staticOriginX = parent.getBounds().getSouthWest()['lat']; // TODO: replace with parent origin
        var staticOriginY = parent.getBounds().getSouthWest()['lng']; // TODO: replace with parent origin
        // } else {
        //     var staticOriginX = parent.getBounds().getCenter()['lat']; // TODO: replace with parent origin
        //     var staticOriginY = parent.getBounds().getCenter()['lng']; // TODO: replace with parent origin
        // }

        let variableOrigin;
        if (direction % 2 === 0) {
            variableOrigin = staticOriginY;
        } else {
            variableOrigin = staticOriginX;
        }

        let variableOriginY = staticOriginY;
        let variableOriginX = staticOriginX;

        let originPoint = mymap.latLngToContainerPoint([staticOriginX,staticOriginY]);
        let nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
        let nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
        let imageBounds = [[variableOriginX, variableOriginY], nextCornerLatLng];

        let newImage = L.imageOverlay(imagePath, imageBounds, {opacity: 1})
            .addTo(mymap)
            .on('click', function() {
                alert('222');
            });

        let margin = 70; // expressed in lat log. 1 unit = 2px; //TODO: configurable

        while (overlay || margin > 0) {
            if (direction > 0) {
                variableOrigin += 0.01;
            } else {
                variableOrigin -= 0.01;
            }
            if (direction % 2 === 0) {
                variableOriginY = variableOrigin;
            } else {
                variableOriginX = variableOrigin;
            }

            originPoint = mymap.latLngToContainerPoint([variableOriginX, variableOriginY + offset]);
            nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
            nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
            imageBounds = [[variableOriginX, variableOriginY + offset], nextCornerLatLng];

            newImage.setBounds(imageBounds);

            // mechanism to simulate break. once an overlay is detected -> move the image and check again.
            let notIntersection = true;
            imagesList.forEach((localImage) => {
                notIntersection = notIntersection && !localImage.getBounds().intersects(newImage.getBounds());
            });

            overlay = !notIntersection;
            if (!overlay) {
                margin = margin - 1;
            }
        }

        newImage.setBounds(imageBounds);

        console.log("nextCornerLatLng:" + nextCornerLatLng);
        console.log("variableOriginX:" + (variableOriginX) + " variableOriginY:" + (variableOriginY+offset));
        if (Math.abs(imageWidth - imageHeight) < 100) { // Threshold for considering and image square.
            console.log("central");
        } else if (imageWidth > imageHeight) { // horizontal
            console.log("horizontal");
        } else {
            console.log("vertical");
        }

        return newImage;
    }

    // $('.leaflet-overlay-pane').packery({
    //     // options
    //     itemSelector: '.leaflet-image-layer',
    //     gutter: 10
    // });

</script>



</body>
</html>
