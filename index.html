<!DOCTYPE html>
<html>
<head>
    <title>Quick Start - Leaflet</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #mapid {
            height: 100%;
            width: 100%;
            background: #fff
        }
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="packery.pkgd.min.js"></script>
    <script src="script.js"></script>
</head>
<body>

<div id="mapid">
<!--    <div class="leaflet-overlay-pane">-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 201px;" src="images/TomGaustad/TG_2_1200_878.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 200px;" src="images/AndreasTystad/AY_1_1200_800.jpg" alt=""></div>-->
<!--        <div class="leaflet-image-layer"><img style="width: 300px; height: 201px;" src="images/TimHereid/TH_1_1200_803.jpg" alt=""></div>-->
<!--    </div>-->
</div>
<script>



    let linesPattern = [2, 2, 3, 4, 5, 5, 5, 4, 3, 2, 5]; // TODO: configurable
    let viewFocusX = 0.0;
    let viewFocusY = 0.0;

    var imagesList = [];
    $.ajaxSetup({ // avoid array being populated asynchronously
        async: false
    });

    var mymap = L.map('mapid', {
        attributionControl: false,
        zoomControl: false
    }).setView([0.0, 0.0], 8);

    var uniqueImagesPanel = [];
    var restAllImages = [];

    $.getJSON( "images/artist-index.json", function( data ) {
        $.each(data, function (artistName, imageArray) {
            uniqueImagesPanel.push("images/"+artistName+"/"+imageArray[0]); // add first image for unique images panel first
            $.each(imageArray, function (index, imagePath) {
                if (index !== 0) { // add the rest of the images to be added in a
                    restAllImages.push("images/"+artistName+"/"+imagePath);
                }
            });
        });
    });

    // add first image.
    // let imageName = uniqueImagesPanel[0].split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
    // let imageWidth = imageName.split('_')[2];
    // let imageHeight = imageName.split('_')[3].split('.')[0];
    // imagesList.push(addImage(uniqueImagesPanel[0], 0, null, imageWidth, imageHeight));
    // let previousImageWidth = imageWidth;

    // populatePanel(uniqueImagesPanel, restAllImages, linesPattern);

    let imageBounds = [[0, 0], L.latLng(4.36832, 6.591797)];
    L.imageOverlay("images/AdaMiko/AM_3_1200_796.JPG", imageBounds, {opacity: 1})
        .addTo(mymap)
        .on('click', function() {
            alert('222');
        });

    imageBounds = [[0, 7.289999999999889], [4.390229, 13.881226]];
    L.imageOverlay("images/AndreasTystad/AY_1_1200_800.jpg", imageBounds, {opacity: 1})
        .addTo(mymap)
        .on('click', function() {
            alert('222');
        });

    imageBounds = [[5.085114463231637, 10.585612792968696], L.latLng(10.309515, 17.177124)];
    L.imageOverlay("images/DanielRognskog/DR_1_1200_960.jpg", imageBounds, {opacity: 1})
        .addTo(mymap)
        .on('click', function() {
            alert('222');
        });

    imageBounds = [[5.085114463231637, 5.7356127929688], L.latLng(11.603813, 9.893188)];
    L.imageOverlay("images/TanjaSilvestrini/TS_1_757_1200.jpg", imageBounds, {opacity: 1})
        .addTo(mymap)
        .on('click', function() {
            alert('222');
        });

    imageBounds = [[-5.105536485492282, 7.814400634765651], L.latLng(-0.703107, 14.408569)];
    L.imageOverlay("images/TimHereid/TH_1_1200_803.jpg", imageBounds, {opacity: 1})
        .addTo(mymap)
        .on('click', function() {
            alert('222');
        });

    // let imageBounds = [[variableOriginX, variableOriginY], nextCornerLatLng];
    //
    // let newImage = L.imageOverlay(imagePath, imageBounds, {opacity: 1})
    //     .addTo(mymap)
    //     .on('click', function() {
    //         alert('222');
    //     });
    // imagesList.push(newImage);

    function extractImageAndProcess(imagePath, direction, parentIndex, imageWidth, imageHeight, lineLimit, toggleDirection, index, restAllImages, linesPattern) {
        imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight));
        parentIndex++;

        // calculate if limit of pictures for current line is reached
        // if (imageWidth <= previousImageWidth) {
        //     lineLimit--;
        // }
        // previousImageWidth = imageHeight;

        // if images is already moved up, toggle back to horizontal moving.
        // if (Math.abs(direction) === 1) {
        //     direction = 2 * toggleDirection;
        // }

        // insert one image upwards and change direction
        // console.log(lineLimit);
        if (lineLimit === 0) {
            if (index < restAllImages.length / 3) {
                direction = 1;
            } else {
                direction = -1;
            }
            toggleDirection *= -1;
            lineLimit = linesPattern.pop();
        }
        return {direction, parentIndex, lineLimit, toggleDirection};
    }

    function populatePanel(uniqueImagesPanel, restAllImages, linesPattern) {
        let direction = 2; // starting direction right
        let toggleDirection = 1; // switch between adding to the right and adding to the left
        let lineLimit = linesPattern.pop();
        let parentIndex = 0; //TODO: remove?

        // $.each(uniqueImagesPanel, function(index, imagePath) {
        let randomItemArray = [];
        let interation = 0;
        while (randomItemArray.length < uniqueImagesPanel.length) {
            let number1 = Math.round(Math.random() * (uniqueImagesPanel.length - 2)) + 1;
            let imagePath = uniqueImagesPanel[number1];

            while (randomItemArray.includes(imagePath) && interation <= restAllImages.length) {
                let number2 = Math.round(Math.random() * (uniqueImagesPanel.length - 2)) + 1;
                imagePath = uniqueImagesPanel[number2];
                interation++;
            }
            randomItemArray.push(imagePath);

            let imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
            let imageWidth = imageName.split('_')[2];
            let imageHeight = imageName.split('_')[3].split('.')[0];

            // if (index !== 0) { // first image is added separately above.
            imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight, toggleDirection));
            parentIndex++;
            toggleDirection *= -1;

            if (direction === 1) {
                // viewFocusX -= 2;
                direction = -2;
            } else if (direction === -1) {
                viewFocusX += 2;
                direction = 2;
            } else if (direction === 2) {
                viewFocusY +=2;
                direction = 1;
            } else if (direction === -2) {
                viewFocusY -= 2;
                direction = -1;
            }
            // }
        }
        // });

        randomItemArray = [];
        // $.each(restAllImages, function(index, imagePath) {
        while (randomItemArray.length < restAllImages.length) {
            let imagePath = restAllImages[Math.abs(Math.round(Math.random() * restAllImages.length) - 1)];
            interation = 0;
            while (randomItemArray.includes(imagePath) && interation <= restAllImages.length) {
                let number = Math.abs(Math.round(Math.random() * restAllImages.length) - 1);
                imagePath = restAllImages[number];
                interation++;
            }
            randomItemArray.push(imagePath);

            imageName = imagePath.split('/')[2]; // get image name only from format images/adaMiko/1_000_000.jpg
            imageWidth = imageName.split('_')[2];
            imageHeight = imageName.split('_')[3].split('.')[0];

            imagesList.push(addImage(imagePath, direction, imagesList[parentIndex], imageWidth, imageHeight, toggleDirection));
            parentIndex++;
            toggleDirection *= -1;

            if (direction === 1) {
                viewFocusX += 1;
                direction = -2;
            } else if (direction === -1) {
                viewFocusX -= 1;
                direction = 2;
            } else if (direction === 2) {
                viewFocusY +=1;
                direction = 1;
            } else if (direction === -2) {
                viewFocusY -= 1;
                direction = -1;
            }
        }

        // });

        console.log(viewFocusX + "::" + viewFocusY);
        mymap.setView([viewFocusX, viewFocusY], 8)
    }
    // 1 = UP
    // -1 = DOWN
    // 2 = RIGHT
    // -2 = LEFT

    mymap.setZoom(5);


    function addImage(imagePath, direction, parent, imageWidth, imageHeight, toggleDirection) {
        // console.log(imagePath + ":" + direction);
        if (direction === 0) { // this is the first image that has to be placed in the center
            let originPoint = mymap.latLngToContainerPoint([0,0]);
            let nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
            let nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
            let imageBounds = [[0, 0], nextCornerLatLng];
            console.log("nextCornerLatLng:" + nextCornerLatLng);
            console.log("variableOriginX:" + 0 + " variableOriginY:" + 0);
            return L.imageOverlay(imagePath, imageBounds).addTo(mymap);
        }

        let overlay = true;
        if (toggleDirection === 1) {
            var staticOriginX = parent.getBounds().getSouthWest()['lat']; // TODO: replace with parent origin
            var staticOriginY = parent.getBounds().getSouthWest()['lng']; // TODO: replace with parent origin
        } else {
            var staticOriginX = parent.getBounds().getCenter()['lat']; // TODO: replace with parent origin
            var staticOriginY = parent.getBounds().getCenter()['lng']; // TODO: replace with parent origin
        }

        let variableOrigin;
        if (direction % 2 === 0) {
            variableOrigin = staticOriginY;
        } else {
            variableOrigin = staticOriginX;
        }

        let variableOriginY = staticOriginY;
        let variableOriginX = staticOriginX;

        let originPoint = mymap.latLngToContainerPoint([staticOriginX,staticOriginY]);
        let nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
        let nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
        let imageBounds = [[variableOriginX, variableOriginY], nextCornerLatLng];

        let newImage = L.imageOverlay(imagePath, imageBounds, {opacity: 1})
            .addTo(mymap)
            .on('click', function() {
                alert('222');
            });

        let margin = 70; // expressed in lat log. 1 unit = 2px; //TODO: configurable

        while (overlay || margin > 0) {
            if (direction > 0) {
                variableOrigin += 0.01;
            } else {
                variableOrigin -= 0.01;
            }
            if (direction % 2 === 0) {
                variableOriginY = variableOrigin;
            } else {
                variableOriginX = variableOrigin;
            }

            originPoint = mymap.latLngToContainerPoint([variableOriginX, variableOriginY]);
            nextCornerPoint = originPoint.add({x: parseInt(imageWidth), y: parseInt(imageHeight)*-1});
            nextCornerLatLng = mymap.containerPointToLatLng(nextCornerPoint);
            imageBounds = [[variableOriginX, variableOriginY], nextCornerLatLng];

            newImage.setBounds(imageBounds);

            // mechanism to simulate break. once an overlay is detected -> move the image and check again.
            let notIntersection = true;
            imagesList.forEach((localImage) => {
                notIntersection = notIntersection && !localImage.getBounds().intersects(newImage.getBounds());
            });

            overlay = !notIntersection;
            if (!overlay) {
                margin = margin - 1;
            }
        }

        console.log("nextCornerLatLng:" + nextCornerLatLng);
        console.log("variableOriginX:" + variableOriginX + " variableOriginY:" + variableOriginY);

        return newImage;
    }

    // $('.leaflet-overlay-pane').packery({
    //     // options
    //     itemSelector: '.leaflet-image-layer',
    //     gutter: 10
    // });

</script>



</body>
</html>
